Title: google app engine service login
Date: 2010/08/16
Slug: google-app-engine-service-login
Tags: python
Link: 
Description: 


So I'm working on an app during my sabbatical that has an iPad component and an online Google App Engine component.  The Google App Engine part is half web based and half web service based.  Of course this means that the local client part has to be able to authenticate itself to the Google App Engine before it can communicate and do useful stuff.  Finding good reliable examples of how to do this is surprisingly hard.  For the Objective C code I'm working on I found a nice set of classes that do the trick for you here:  <a href="http://github.com/cameronr/GoogleAppEngineAuth">On Github</a>  For Python I found some example code on <a href="http://stackoverflow.com/questions/101742/how-do-you-access-an-authenticated-google-app-engine-service-from-a-non-web-p">stackoverflow</a>.  However it was not really in a reusable form.<br /><br />The basic outline of what you have to do is as follows:<br /><br />1.  Login to https://www.google.com/accounts/ClientLogin  This will give you an auth token.<br />2.  Use the token you gained in step 1 to login to your Google App engine application or service.  When you have successfully logged in to your service google will set an ACSID cookie for you to use when you make subsequent requests to your service.  This prevents you from having to login each time you make a web service request.<br /><br />I've taken some ideas from both places mentioned above and have created a Python class for logging in and accessing app engine services from Python.  To use this module you just need to import it and create a GoogleAppEngineLogin object.  Once the object is created you can use the open method on the object to access further services.  The open method is just a convenience wrapper around urllib2.urlopen but it also makes sure that your cookie has not expired before it makes a request.  If you have comments or suggestions for how to improve the code please let me know via email or leave a comment.<br /><br />The code is reproduced below, but you can also just download the file from git clone git@gist.github.com:36b1c45ed39298178907.git<br /><pre class="prettyprint" style="overflow: auto;"><br />import getpass<br />import urllib<br />import urllib2<br />import cookielib<br /><br /><br />class GoogleAppEngineLogin(object):<br />    """<br />   Logging in to an App Engine Account (when you use google users) is<br />   a two step process: First you must login to Google generally.  This<br />   gets you an auth token.  The auth token is used as part of a<br />   request to login to your app/service During the login process for<br />   your app/service the server sets a cookie with the name of ACSID,<br />   it is this cookie and its value that serves as the authentication<br />   token for your own service/app.  So, for future requests you need<br />   to give the server the cookie as part of your request.  Handling<br />   cookies can be a bit tricky if you haven't had some experience with<br />   it but luckily Python's cookielib module makes it all pretty<br />   automatic.<br /><br />    This class takes care of the whole login process for you, and then<br />    gives you a simple helper to access the URLs for your service.<br />    The helper function makes sure the cookie is still valid and<br />    passes on the request along with the cookie.  Technically you<br />    would not even need to use the helper function, you could use<br />    urllib2 directly to access your service but this seems a bit<br />    neater to me.<br /><br />    Some of this code was inspired by and lifted from an example on<br />    stackoverflow.com, but that was all in-line code my contribution<br />    is to add some error handling and encapsulate the whole thing<br />    inside a class to make it easier to include in my/your own<br />    programs.  Here's a link to the original thread on stackoverflow<br />    http://stackoverflow.com/questions/101742/how-do-you-access-an-authenticated-google-app-engine-service-from-a-non-web-pyt<br /><br />    """<br />    <br />    def __init__(self, user_email, user_pw, uri, source):<br />        """<br />        Create a Google App Engine Object.<br />        Arguments:<br />        - `user_email`:  your google username<br />        - `user_pw`: your google password<br />        - `uri`:  The url of your google app engine service<br />        - `source`: The unique name of your google app engine service<br />        """<br />        self._user_email = user_email<br />        self._user_pw = user_pw<br />        self._uri = uri<br />        self._source = source<br />        self._authtoken = None<br />        self._auth_cookie = None<br />        <br />        if not self.google_client_login():<br />            raise RuntimeError("Could not login to Google")<br />        <br />        if not self.app_engine_login():<br />            raise RuntimeError("Could not login to your application")<br /><br />        <br />    def google_client_login(self):<br />        #<br />        # get an AuthToken from Google accounts<br />        #<br />        auth_uri = 'https://www.google.com/accounts/ClientLogin'<br />        authreq_data = urllib.urlencode({ "Email":   self._user_email,<br />                                          "Passwd":  self._user_pw,<br />                                          "service": "ah",<br />                                          "source":  self._source,<br />                                          "accountType": "HOSTED_OR_GOOGLE" })<br />        auth_req = urllib2.Request(auth_uri, data=authreq_data)<br />        try:<br />            auth_resp = urllib2.urlopen(auth_req)<br />            auth_resp_body = auth_resp.read()<br />        except:<br />            return False<br />        # auth response includes several fields - we're interested in <br />        #  the bit after Auth= <br />        auth_resp_dict = dict(x.split("=")<br />                              for x in auth_resp_body.split("\n") if x)<br />        try:<br />            self._authtoken = auth_resp_dict["Auth"]<br />        except:<br />            return False<br /><br />        return True<br /><br />    def app_engine_login(self):<br />        #<br />        #  Get a cookie<br />        #  we use a cookie to authenticate with Google App Engine<br />        #  by registering a cookie handler here, this will automatically store the <br />        #  cookie returned when we use urllib2 to open<br />        #  http://www.google.com/accounts/ClientLogin<br />        self._cookiejar = cookielib.LWPCookieJar()<br />        opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(self._cookiejar))<br />        urllib2.install_opener(opener)<br /><br /><br />        serv_args = {}<br />        serv_args['continue'] = self._uri<br />        serv_args['auth']     = self._authtoken<br /><br />        full_serv_uri = "%s/_ah/login?%s" % (self._uri,urllib.urlencode(serv_args))<br /><br />        serv_req = urllib2.Request(full_serv_uri)<br />        serv_resp = urllib2.urlopen(serv_req)<br />        serv_resp_body = serv_resp.read()<br /><br /><br />        for i, c in enumerate(self._cookiejar):<br />            if c.name == 'ACSID':<br />                self._auth_cookie = c<br />                return True<br /><br />        return False<br /><br />    def open(self,url,data=None):<br />        """<br />        url should be a properly encoded url ready to go.  data is<br />        optional and should be used to provide parameters to pass<br />        along with the URL when you want to use POST instead of GET.<br />        If you provide data it must be properly encoded just as if you<br />        were calling urlopen directly yourself.<br />        """<br />        if self._auth_cookie.is_expired():<br />            if not self.google_client_login() or not self.app_engine_login():<br />                raise RuntimeError("Cannot get proper authorization for this request")<br />            <br />        serv_req = urllib2.Request(url,data)<br />        return urllib2.urlopen(serv_req)<br />        <br /><br />if __name__ == "__main__":<br />    user = raw_input("User: ")<br />    pw = getpass.getpass("Password: ")<br />    service_url = "http://myapp.appspot.com"<br />    service_name = "myapp"<br />    gae = GoogleAppEngineLogin(user,pw,service_url,service_name)<br />    h = gae.open("http://myapp.appspot.com/my/service")<br />    print h.read()<br />        <br /></pre><br /><br /><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/2759017781463016019-6097603738466978791?l=blog.bonelakesoftware.com' alt='' /></div>
